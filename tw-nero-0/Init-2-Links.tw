:: Init 2 Links [inclusion] {"position":"2450,600","size":"100,100"}
<<script>>

/**
 * <<mta $link [$code]>>
 *   $text
 * <</mta>>
 * 
 * Similar to <<link $text $link>><<run $code>><</link>>
 * Allows double-bracket syntax for the link.
 * Adds a data-mt-code attribute for disambiguation.
 * Also arranges for the next passage to get the code as _mtaCode
 */
Macro.add("mta", {
  tags: [],
  handler: function() {
    const [link, code] = this.args;
    const text = this.payload[0].contents;
    makeLink(link, code, text)
      .appendTo(this.output);
  }
});

/**
 * <<mtl $link [$script]>>
 *   $text
 * <</mtl>>
 * 
 * <<mta>> but wrapped in <li></li>
 */
Macro.add("mtl", {
  tags: [],
  handler: function() {
    const [link, code] = this.args;
    const text = this.payload[0].contents;
    $("<li>").append(makeLink(link, code, text))
      .appendTo(this.output);
  }
});

function makeLink(link, code, text) {
  const T = State.temporary;
  T.mtaThisDest = linkTitle(link);
  T.mtaThisText = String(text);
  let body = "";
  if (code != null) {
    T.mtaThisPayload = code;
    body = `<<run $mtaPayload = _mtaThisPayload>><<run ${code}>>`;
  }
  const el = document.createDocumentFragment();
  $(el).wiki(`<<link _mtaThisText _mtaThisDest>>${body}<</link>>`);
  if (code != null) {
    $(el).find("a").attr("data-mt-code", code);
  }
  return el;
}

$(document).on(":passagestart", () => {
  const T = State.temporary;
  const V = State.variables;
  if (V.mtaPayload != null) {
    T.mtaCode = V.mtaPayload;
    delete V.mtaPayload;
  }
})

function linkTitle(link) {
  if (link.isLink) return link.link;
  const str = String(link);
  const m = /^\[\[(?:[^|]+\|)?([^|]+)\]\]$/.exec(str);
  return m == null ? str : m[1];
}

<</script>>
